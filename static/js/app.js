(()=>{function _(){let e=document.getElementById("panelSidebar"),t=document.getElementById("panelSidebarToggle");if(!e||e.dataset.bound==="1")return;e.dataset.bound="1";let s="adli_sidebar_collapsed",n="w-72",o="w-20",a=()=>e.querySelectorAll(".sidebar-label"),r=0,u=null,g=()=>{a().forEach(i=>{i.classList.add("hidden"),i.classList.remove("opacity-100"),i.classList.add("opacity-0")})},f=()=>{a().forEach(i=>{i.classList.remove("hidden"),i.classList.remove("opacity-0"),i.classList.add("opacity-100")})};a().forEach(i=>i.classList.add("transition-opacity","duration-200"));let c=i=>{document.documentElement.style.setProperty("--sidebar-w",i?"5rem":"18rem"),document.documentElement.dataset.sidebarCollapsed=i?"1":"0"},d=i=>{e.classList.toggle(n,!i),e.classList.toggle(o,i)},m=()=>{u&&(clearTimeout(u),u=null)},l=()=>{r+=1;let i=r;m(),d(!1),c(!1);let p=B=>{B.propertyName==="width"&&(e.removeEventListener("transitionend",p),i===r&&f())};e.addEventListener("transitionend",p),u=setTimeout(()=>{i===r&&f()},320)},b=()=>{r+=1,m(),g(),d(!0),c(!0)},y=i=>{i?b():l()},h=localStorage.getItem(s)==="1";y(h),t&&!t.dataset.bound&&(t.dataset.bound="1",t.addEventListener("click",()=>{let p=!(localStorage.getItem(s)==="1");localStorage.setItem(s,p?"1":"0"),y(p)})),e.addEventListener("mouseenter",()=>{localStorage.getItem(s)==="1"&&l()}),e.addEventListener("mouseleave",()=>{localStorage.getItem(s)==="1"&&b()})}function D(){let e=document.getElementById("panelMobileOpen"),t=document.getElementById("panelMobileClose"),s=document.getElementById("panelMobileSidebar"),n=document.getElementById("panelMobileBackdrop");if(!e||!t||!s||!n||e.dataset.bound==="1")return;e.dataset.bound="1";let o=!1,a=()=>{o||(o=!0,n.classList.remove("pointer-events-none"),s.classList.remove("pointer-events-none"),n.classList.remove("opacity-0"),n.classList.add("opacity-100"),s.classList.remove("-translate-x-full","opacity-0"),s.classList.add("translate-x-0","opacity-100"))},r=()=>{o&&(o=!1,n.classList.remove("opacity-100"),n.classList.add("opacity-0"),s.classList.remove("translate-x-0","opacity-100"),s.classList.add("-translate-x-full","opacity-0"),setTimeout(()=>{o||(n.classList.add("pointer-events-none"),s.classList.add("pointer-events-none"))},220))};s.dataset.closeFn="1",window.__adliCloseMobileSidebar=r,e.addEventListener("click",a),t.addEventListener("click",r),n.addEventListener("click",r),document.body.dataset.mobileEscBound||(document.body.dataset.mobileEscBound="1",document.addEventListener("keydown",u=>{u.key==="Escape"&&typeof window.__adliCloseMobileSidebar=="function"&&window.__adliCloseMobileSidebar()}))}function v(){let e=document.body.dataset.notSelected||"\u041D\u0435 \u0432\u044B\u0431\u0440\u0430\u043D",t=document.getElementById("id_target_department"),s=document.getElementById("id_target_employee"),n=document.getElementById("depLabel"),o=document.getElementById("empLabel"),a=document.getElementById("empSearch"),r=document.getElementById("empList");if(!t||!s||!n||!o||!r)return;function u(c,d){c.value=d,c.dispatchEvent(new Event("change",{bubbles:!0}))}function g(c){r.querySelectorAll(".emp-item").forEach(d=>{let m=d.getAttribute("data-dep")||"";d.style.display=!c||m===c?"":"none"})}function f(c){let d=document.getElementById(c);d&&d.classList.add("hidden")}document.body.dataset.resDropBound||(document.body.dataset.resDropBound="1",document.addEventListener("click",c=>{let d=document.getElementById("depMenu"),m=document.getElementById("empMenu");d&&!c.target.closest("#depMenu")&&!c.target.closest("#depBtn")&&d.classList.add("hidden"),m&&!c.target.closest("#empMenu")&&!c.target.closest("#empBtn")&&m.classList.add("hidden");let l=c.target.closest("button[data-set]");if(!l)return;let b=l.dataset.set,y=l.dataset.id||"",h=l.dataset.label||"";if(b==="dep"){u(t,y),n.textContent=h||e,u(s,""),o.textContent=e,g(y),f("depMenu");return}if(b==="emp"){let i=t.value||"",p=l.dataset.dep||"";if(i&&p&&i!==p)return;u(s,y),o.textContent=h||e,f("empMenu")}},{capture:!0})),g(t.value||""),a&&a.dataset.bound!=="1"&&(a.dataset.bound="1",a.addEventListener("input",()=>{let c=a.value.trim().toLowerCase();r.querySelectorAll(".emp-item").forEach(d=>{let m=d.getAttribute("data-name")||"";d.style.display=m.includes(c)?"":"none"})}))}function C(){document.addEventListener("click",e=>{let t=e.target.closest("[data-dep-asst-id]");if(!t)return;let s=t.closest("form");if(!s)return;let n=s.querySelector("#depAsstInput"),o=s.querySelector("#depAsstLabel"),a=s.querySelector("#depAsstMenu");n&&(n.value=t.dataset.depAsstId||""),o&&(o.textContent=t.dataset.depAsstLabel||"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435..."),a&&a.classList.add("hidden"),e.preventDefault(),e.stopPropagation()})}document.addEventListener("DOMContentLoaded",()=>{C()});function E(){document.querySelectorAll('input[type="date"]').forEach(e=>{if(e.dataset.dateBound==="1")return;e.dataset.dateBound="1";let t=0,s=()=>{let n=Date.now();n-t<180||(t=n,typeof e.showPicker=="function"?e.showPicker():e.focus())};e.addEventListener("click",s),e.addEventListener("focus",s)})}function S(){let e=document.getElementById("toast-stack");if(!e)return;let t=e.querySelectorAll(".adli-toast:not([data-init='1'])");function s(o){requestAnimationFrame(()=>{o.classList.remove("opacity-0","translate-x-8"),o.classList.add("opacity-100","translate-x-0")})}function n(o){o.classList.remove("opacity-100","translate-x-0"),o.classList.add("opacity-0","translate-x-8"),setTimeout(()=>o.remove(),320)}t.forEach(o=>{o.dataset.init="1",s(o);let a=o.querySelector(".adli-toast-close");a&&!a.dataset.bound&&(a.dataset.bound="1",a.addEventListener("click",()=>n(o)));let r=parseInt(o.dataset.delay||"4500",10);setTimeout(()=>n(o),r)})}function R(e,t){let s=document.querySelector(`[data-chart-error="${e}"]`);s&&(s.textContent=t,s.classList.remove("hidden"))}function I(e){let t=document.querySelector(`[data-chart-error="${e}"]`);t&&(t.classList.add("hidden"),t.textContent="")}function A(e){e.querySelectorAll(".dash-card").forEach((s,n)=>{s.style.opacity="0",s.style.transform="translateY(8px)",s.style.transition="opacity 260ms ease, transform 260ms ease",setTimeout(()=>{s.style.opacity="1",s.style.transform="translateY(0)"},40+n*40)})}function L(e){let t=document.getElementById(e);if(!t)return null;try{let s=echarts.getInstanceByDom(t);s&&s.dispose()}catch{}return echarts.init(t)}function O(e){let t=()=>{e.forEach(s=>s&&s.resize())};if(window.addEventListener("resize",t),window.ResizeObserver){let s=new ResizeObserver(()=>t());e.forEach(n=>{n&&s.observe(n.getDom())})}}function M(e){if(!e)return;let t=(s,n)=>{let o=document.getElementById(s);o&&(o.textContent=n??"0")};t("kpiRequestsTotal",e.requests?.total),t("kpiRequestsNew",e.requests?.new),t("kpiRequestsInProgress",e.requests?.in_progress),t("kpiRequestsOverdue",e.requests?.overdue),t("kpiRequestsDoneToday",e.requests?.done_today),t("kpiCompaniesTotal",e.companies?.total),t("kpiCompaniesWithRegion",e.companies?.with_region),t("kpiCompaniesWithoutRegion",e.companies?.without_region),t("kpiCompaniesWithoutCategory",e.companies?.without_category),t("kpiCompaniesWithoutDirections",e.companies?.without_directions)}function k(e,t){let s=L(e);if(!s)return null;let n=t?.series||[];return s.setOption({tooltip:{trigger:"item"},legend:{top:"bottom"},series:[{name:"status",type:"pie",radius:["45%","70%"],avoidLabelOverlap:!0,itemStyle:{borderRadius:6,borderColor:"#fff",borderWidth:2},label:{show:!1},emphasis:{label:{show:!0,fontSize:12,fontWeight:"bold"}},labelLine:{show:!1},data:n,animationDuration:700,animationEasing:"cubicOut"}]}),s}function T(e,t,s){let n=L(e);return n?(n.setOption({tooltip:{trigger:"item"},legend:{top:"bottom"},series:[{name:t,type:"pie",radius:["40%","70%"],avoidLabelOverlap:!0,itemStyle:{borderRadius:6,borderColor:"#fff",borderWidth:2},label:{show:!1},emphasis:{label:{show:!0,fontSize:12,fontWeight:"bold"}},labelLine:{show:!1},data:s,animationDuration:700,animationEasing:"cubicOut"}]}),n):null}function x(e,t,s={}){let n=L(e);if(!n)return null;let o=t?.labels||[],a=t?.values||[];return n.setOption({tooltip:{trigger:"axis"},grid:{left:24,right:16,top:16,bottom:48,containLabel:!0},xAxis:{type:"category",data:o,axisLabel:{rotate:s.rotateLabels?25:0}},yAxis:{type:"value"},series:[{type:"bar",data:a,animationDuration:700,animationEasing:"cubicOut"}]}),n}function w(e,t){let s=L(e);if(!s)return null;let n=t?.labels||[],o=t?.values||[];return s.setOption({tooltip:{trigger:"axis"},grid:{left:24,right:16,top:16,bottom:16,containLabel:!0},xAxis:{type:"value"},yAxis:{type:"category",data:n},series:[{type:"bar",data:o,animationDuration:700,animationEasing:"cubicOut"}]}),s}function P(e,t,s){let n=L(e);if(!n)return null;let o=t?.labels||[],a=t?.values||[],r=s?.values||[];return n.setOption({tooltip:{trigger:"axis"},legend:{top:8},grid:{left:24,right:16,top:36,bottom:48,containLabel:!0},xAxis:{type:"category",data:o},yAxis:{type:"value"},series:[{name:"\u0421\u043E\u0437\u0434\u0430\u043D\u043E",type:"line",data:a,smooth:!0,animationDuration:700,animationEasing:"cubicOut"},{name:"\u0417\u0430\u043A\u0440\u044B\u0442\u043E",type:"line",data:r,smooth:!0,animationDuration:700,animationEasing:"cubicOut"}]}),n}async function W(e){let t=await fetch(e,{headers:{"X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(!t.ok)throw new Error(`HTTP ${t.status}`);return await t.json()}function q(){let e=document.getElementById("dashboardRoot");if(!e)return;let t=e.dataset.dashboardUrl;if(!t)return;let s=document.getElementById("dashboardRefreshBtn"),n=[],o=async()=>{try{let a=await W(t);M(a.kpi),["chartRequestsStatus","chartRequestsDirections","chartRequestsRegions","chartRequestsTimeline","chartSlaOverdueDepartments","chartCompaniesCategories","chartCompaniesRegions","chartDataQuality"].forEach(I);let r=k("chartRequestsStatus",a.requests_by_status),u=x("chartRequestsDirections",a.requests_by_direction,{rotateLabels:!0}),g=w("chartRequestsRegions",a.requests_by_region),f=P("chartRequestsTimeline",a.requests_timeline_created,a.requests_timeline_done),c=w("chartSlaOverdueDepartments",a.sla_overdue_by_department),d=x("chartCompaniesCategories",a.companies_by_category,{rotateLabels:!0}),m=w("chartCompaniesRegions",a.companies_by_region),l=a.data_quality||{},b=l.total||0,y=Math.max(0,b-(l.missing_region||0)-(l.missing_district||0)-(l.missing_category||0)),h=[{name:"\u0411\u0435\u0437 \u0440\u0435\u0433\u0438\u043E\u043D\u0430",value:l.missing_region||0},{name:"\u0411\u0435\u0437 \u0440\u0430\u0439\u043E\u043D\u0430",value:l.missing_district||0},{name:"\u0411\u0435\u0437 \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0438",value:l.missing_category||0},{name:"\u0411\u0435\u0437 \u043D\u0430\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u0438\u0439",value:l.missing_directions||0}],i=T("chartDataQuality","\u041A\u0430\u0447\u0435\u0441\u0442\u0432\u043E \u0434\u0430\u043D\u043D\u044B\u0445",h);n=[r,u,g,f,c,d,m,i].filter(Boolean),O(n),A(e)}catch(a){let r="\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0430\u043D\u0430\u043B\u0438\u0442\u0438\u043A\u0443.";["chartRequestsStatus","chartRequestsDirections","chartRequestsRegions","chartRequestsTimeline","chartSlaOverdueDepartments","chartCompaniesCategories","chartCompaniesRegions","chartDataQuality"].forEach(u=>R(u,r)),console.error("[dashboard] load failed:",a)}};s&&s.addEventListener("click",o),o()}function z(){_(),D(),v(),E(),S(),q()}document.addEventListener("DOMContentLoaded",z);document.body.addEventListener("htmx:afterSwap",()=>{v(),E(),S(),q()});})();
