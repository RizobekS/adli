{% extends "base_public.html" %}
{% load i18n %}

{% block title %}{% trans "Отправка обращения" %} | ADLI{% endblock %}

{% block content %}
    <section class="mb-6">
        <div class="rounded-2xl shadow bg-white p-6">
            <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
                <div>
                    <h1 class="text-2xl font-semibold">{% trans 'Отправка обращения' %}</h1>
                    <p class="text-gray-500">{% trans 'Заполните данные для отправки обращения.' %}</p>
                </div>
                <div class="mt-2 md:mt-0">
          <span class="inline-flex items-center rounded-full bg-blue-50 px-3 py-1 text-sm font-medium text-blue-700 border border-blue-100">
            {% trans 'ADLI • Форма для обращений' %}
          </span>
                </div>
            </div>
        </div>
    </section>

    <div class="rounded-2xl shadow bg-white p-6">
        <form method="post" enctype="multipart/form-data" class="space-y-6"
            data-public-request-form="1"
            data-districts-url="{% url 'companies:districts_by_region' %}"
            data-directions-url="{% url 'companies:directions_by_category_json' %}">
            {% csrf_token %}

            <!-- скрытые реальные select'ы, на них висит HTMX/валидация -->
            <div class="hidden">
                {{ form.category }}
                {{ form.region }}
                {{ form.district }}
            </div>

            <!-- Company -->
            <div>
                <h2 class="text-lg font-medium mb-3">{% trans "Компания" %}</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        {{ form.inn.label_tag }}
                        {{ form.inn }}
                        {% if form.inn.errors %}<p class="text-sm text-red-600">{{ form.inn.errors }}</p>{% endif %}
                    </div>

                    <div>
                        {{ form.company_name.label_tag }}
                        {{ form.company_name }}
                        {% if form.company_name.errors %}
                            <p class="text-sm text-red-600">{{ form.company_name.errors }}</p>{% endif %}
                    </div>
                </div>

                <!-- Region/District dropdowns -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                    <!-- Region -->
                    <div class="relative">
                        <label class="block mb-2 text-sm font-medium">{% trans "Регион" %}</label>

                        <button id="reqRegionBtn" data-dropdown-toggle="reqRegionMenu" type="button"
                                class="form-control flex items-center justify-between px-4">
                            <span id="reqRegionLabel">{% trans "Выберите регион" %}</span>
                            <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>

                        <div id="reqRegionMenu"
                             class="z-20 hidden w-full rounded-xl border border-gray-200 bg-white shadow-lg">
                            <ul class="max-h-64 overflow-auto py-1 text-sm">
                                <li>
                                    <button type="button" class="w-full px-3 py-2 text-left hover:bg-gray-50"
                                            data-set="req-region" data-id="" data-label="{% trans 'Выберите регион' %}">
                                        {% trans "Не выбрано" %}
                                    </button>
                                </li>
                                {% for r in regions %}
                                    <li>
                                        <button type="button" class="w-full px-3 py-2 text-left hover:bg-gray-50"
                                                data-set="req-region" data-id="{{ r.id }}" data-label="{{ r.name }}">
                                            {{ r.name }}
                                        </button>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>

                    <!-- District -->
                    <div class="relative">
                        <label class="block mb-2 text-sm font-medium">{% trans "Район/город" %}</label>

                        <button id="reqDistrictBtn" data-dropdown-toggle="reqDistrictMenu" type="button"
                                class="form-control flex items-center justify-between px-4 disabled:opacity-60"
                                disabled>
                            <span id="reqDistrictLabel">{% trans "Выберите район/город" %}</span>
                            <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>

                        <p id="reqDistrictHint" class="mt-1 hidden text-xs text-amber-700">
                            {% trans "Сначала выберите регион." %}
                        </p>

                        <div id="reqDistrictMenu"
                             class="z-20 hidden w-full rounded-xl border border-gray-200 bg-white shadow-lg">
                            <div class="p-2 border-b">
                                <input id="reqDistrictSearch" type="text" class="form-control"
                                       placeholder="{% trans 'Поиск района…' %}">
                            </div>
                            <ul id="reqDistrictList" class="max-h-64 overflow-auto py-1 text-sm">
                                <li class="px-3 py-2 text-gray-500">{% trans "Сначала выберите регион" %}</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Employee -->
            <div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>{{ form.last_name.label_tag }}{{ form.last_name }}</div>
                    <div>{{ form.first_name.label_tag }}{{ form.first_name }}</div>
                    <div>{{ form.middle_name.label_tag }}{{ form.middle_name }}</div>
                    <div>{{ form.phone.label_tag }}{{ form.phone }}</div>
                    <div>{{ form.email.label_tag }}{{ form.email }}</div>

                </div>
            </div>

            <!-- Request -->
            <div>
                <div class="grid grid-cols-2 gap-4">
                    <!-- Category dropdown -->
                    <div class="relative">
                        <label class="block mb-2 text-sm font-medium">{% trans "Категория" %}</label>

                        <button id="reqCategoryBtn" data-dropdown-toggle="reqCategoryMenu" type="button"
                                class="form-control flex items-center justify-between px-4">
                            <span id="reqCategoryLabel">{% trans "Выберите категорию" %}</span>
                            <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>

                        <div id="reqCategoryMenu"
                             class="z-20 hidden w-full rounded-xl border border-gray-200 bg-white shadow-lg">
                            <ul class="max-h-64 overflow-auto py-1 text-sm">
                                <li>
                                    <button type="button" class="w-full px-3 py-2 text-left hover:bg-gray-50"
                                            data-set="req-category" data-id=""
                                            data-label="{% trans 'Выберите категорию' %}">
                                        {% trans "Не выбрано" %}
                                    </button>
                                </li>
                                {% for c in categories %}
                                    <li>
                                        <button type="button" class="w-full px-3 py-2 text-left hover:bg-gray-50"
                                                data-set="req-category" data-id="{{ c.id }}" data-label="{{ c.name }}">
                                            {{ c.name }}
                                        </button>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>

                    <!-- Directions multiselect -->
                    <div class="relative">
                      <label class="block mb-2 text-sm font-medium">{% trans "Направления" %}</label>

                      <!-- скрытый select для сабмита формы -->
                      <div class="hidden">
                        {{ form.directions }}
                      </div>

                      <button id="reqDirectionsBtn"
                              type="button"
                              class="form-control flex items-center justify-between px-4 disabled:opacity-60"
                              disabled>
                        <span id="reqDirectionsLabel">{% trans "Выберите направления" %}</span>
                        <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                      </button>

                      <p id="reqDirectionsHint" class="mt-1 hidden text-xs text-amber-700">
                        {% trans "Сначала выберите категорию." %}
                      </p>

                      <div id="reqDirectionsMenu"
                           class="absolute left-0 right-0 top-full mt-2 z-30 hidden w-full rounded-xl border border-gray-200 bg-white shadow-lg max-h-[70vh] overflow-auto">
                        <div class="p-2 border-b">
                          <input id="reqDirectionsSearch" type="text" class="form-control"
                                 placeholder="{% trans 'Поиск направления…' %}">
                        </div>

                        <ul id="reqDirectionsList" class="max-h-72 overflow-auto py-1 text-sm"></ul>

                        <div class="p-2 border-t flex items-center justify-between gap-2">
                          <button type="button" id="reqDirectionsClear"
                                  class="rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm hover:bg-gray-50">
                            {% trans "Очистить" %}
                          </button>
                          <button type="button" id="reqDirectionsDone"
                                  class="rounded-lg bg-blue-700 px-3 py-2 text-sm text-white hover:bg-blue-800">
                            {% trans "Готово" %}
                          </button>
                        </div>
                      </div>

                      <!-- selected chips -->
                      <div id="reqDirectionsChips" class="mt-2 flex flex-wrap gap-2"></div>
                    </div>
                </div>

                <div class="mt-4">
                    <label class="block mb-2 text-sm font-medium">{% trans "Описание обращения" %}</label>
                    {{ form.description }}
                    {% if form.description.errors %}
                        <p class="text-sm text-red-600">{{ form.description.errors }}</p>{% endif %}
                </div>

                <!-- Attachments -->
                <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block mb-2 text-sm font-medium">{% trans "Приложения обращения" %}</label>

                        <div id="attachments-container" class="space-y-2">
                            <div class="flex gap-2">
                                <input type="file"
                                       name="attachments"
                                       accept=".pdf,.doc,.docx,.xls,.xlsx"
                                       class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer p-2 bg-gray-50">
                                <button type="button"
                                        class="remove-attachment hidden shrink-0 rounded-lg border border-gray-300 bg-white px-3 text-sm hover:bg-gray-50">
                                    ✕
                                </button>
                            </div>
                        </div>

                        <button type="button" id="add-attachment"
                                class="mt-2 rounded-lg inline-flex items-center gap-2 border border-green-200 bg-green-300 hover:bg-green-400 text-sm text-center p-2 font-medium text-green-700">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M12 4v16m8-8H4"></path>
                            </svg>
                        </button>

                        <p class="text-xs text-gray-500 mt-1">
                            {% trans "PDF, Word, Excel. Можно добавить несколько файлов." %}<br>
                            {% trans "Максимальный допустимый размер файлов 10MB." %}
                        </p>
                    </div>
                </div>
            </div>

            <div class="flex items-center my-3 gap-3">
                <button type="submit"
                        class="text-white bg-blue-700 hover:bg-blue-800 font-medium rounded-lg text-sm px-5 py-2.5">
                    {% trans "Отправить" %}
                </button>
            </div>

            {% if form.non_field_errors %}
                <div class="p-4 text-sm text-red-800 rounded-lg bg-red-50 border border-red-200">
                    {{ form.non_field_errors }}
                </div>
            {% endif %}
        </form>
    </div>

{% endblock %}
