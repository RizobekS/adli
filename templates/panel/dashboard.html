{% extends "base_panel.html" %}
{% load i18n %}

{% block title %}{% trans "Дашборд" %} | ADLI{% endblock %}

{% block content %}
<div class="space-y-6" id="dashboardRoot"
     data-dashboard-url="{% url 'panel:api_dashboard_all' %}">

  <!-- Header -->
  <div class="flex items-start justify-between gap-4">
    <div>
      <h1 class="text-xl font-semibold">{% trans "Дашборд" %}</h1>
      <p class="text-sm text-gray-600">
        {% trans "Сводная статистика по компаниям и обращениям." %}
      </p>
    </div>

    <div class="flex items-center gap-2">
      <button type="button"
              id="dashboardRefreshBtn"
              class="inline-flex items-center rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">
        {% trans "Обновить" %}
      </button>
    </div>
  </div>

  <!-- KPI cards -->
  <div class="grid grid-cols-1 gap-3 sm:grid-cols-2 lg:grid-cols-4">
    <!-- Requests -->
    <div class="dash-card rounded-2xl border border-gray-200 bg-white p-4 shadow-sm">
      <div class="text-sm text-gray-500">{% trans "Всего обращений" %}</div>
      <div class="mt-1 text-2xl font-semibold" id="kpiRequestsTotal">{{ kpi.requests.total }}</div>
      <div class="mt-2 text-xs text-gray-500">
        {% trans "Новые" %}: <span class="font-medium" id="kpiRequestsNew">{{ kpi.requests.new }}</span> ·
        {% trans "В работе" %}: <span class="font-medium" id="kpiRequestsInProgress">{{ kpi.requests.in_progress }}</span>
      </div>
    </div>

    <div class="dash-card rounded-2xl border border-gray-200 bg-white p-4 shadow-sm">
      <div class="text-sm text-gray-500">{% trans "Просроченные" %}</div>
      <div class="mt-1 text-2xl font-semibold" id="kpiRequestsOverdue">{{ kpi.requests.overdue }}</div>
      <div class="mt-2 text-xs text-gray-500">
        {% trans "Завершено сегодня" %}: <span class="font-medium" id="kpiRequestsDoneToday">{{ kpi.requests.done_today }}</span>
      </div>
    </div>

    <!-- Companies -->
    <div class="dash-card rounded-2xl border border-gray-200 bg-white p-4 shadow-sm">
      <div class="text-sm text-gray-500">{% trans "Всего компаний" %}</div>
      <div class="mt-1 text-2xl font-semibold" id="kpiCompaniesTotal">{{ kpi.companies.total }}</div>
      <div class="mt-2 text-xs text-gray-500">
        {% trans "С регионом" %}: <span class="font-medium" id="kpiCompaniesWithRegion">{{ kpi.companies.with_region }}</span> ·
        {% trans "Без региона" %}: <span class="font-medium" id="kpiCompaniesWithoutRegion">{{ kpi.companies.without_region }}</span>
      </div>
    </div>

    <div class="dash-card rounded-2xl border border-gray-200 bg-white p-4 shadow-sm">
      <div class="text-sm text-gray-500">{% trans "Качество данных" %}</div>
      <div class="mt-1 text-2xl font-semibold" id="kpiCompaniesWithoutCategory">{{ kpi.companies.without_category }}</div>
      <div class="mt-2 text-xs text-gray-500">
        {% trans "Без категории" %} · {% trans "без направлений" %}:
        <span class="font-medium" id="kpiCompaniesWithoutDirections">{{ kpi.companies.without_directions }}</span>
      </div>
    </div>
  </div>

  <!-- Charts -->
  <div class="grid grid-cols-1 gap-4 lg:grid-cols-2">
    <div class="dash-card rounded-2xl border border-gray-200 bg-white p-4 shadow-sm">
      <div class="mb-2 flex items-center justify-between">
        <h2 class="text-sm font-semibold text-gray-900">{% trans "Обращения по статусам" %}</h2>
      </div>
      <div class="h-80" id="chartRequestsStatus"></div>
      <div class="mt-2 hidden text-sm text-red-600" data-chart-error="chartRequestsStatus"></div>
    </div>

    <div class="dash-card rounded-2xl border border-gray-200 bg-white p-4 shadow-sm">
      <div class="mb-2 flex items-center justify-between">
        <h2 class="text-sm font-semibold text-gray-900">{% trans "Обращения по направлениям" %}</h2>
      </div>
      <div class="h-80" id="chartRequestsDirections"></div>
      <div class="mt-2 hidden text-sm text-red-600" data-chart-error="chartRequestsDirections"></div>
    </div>

    <div class="dash-card rounded-2xl border border-gray-200 bg-white p-4 shadow-sm">
      <div class="mb-2 flex items-center justify-between">
        <h2 class="text-sm font-semibold text-gray-900">{% trans "Обращения по регионам" %}</h2>
      </div>
      <div class="h-80" id="chartRequestsRegions"></div>
      <div class="mt-2 hidden text-sm text-red-600" data-chart-error="chartRequestsRegions"></div>
    </div>

    <div class="dash-card rounded-2xl border border-gray-200 bg-white p-4 shadow-sm">
      <div class="mb-2 flex items-center justify-between">
        <h2 class="text-sm font-semibold text-gray-900">{% trans "Динамика обращений" %}</h2>
      </div>
      <div class="h-80" id="chartRequestsTimeline"></div>
      <div class="mt-2 hidden text-sm text-red-600" data-chart-error="chartRequestsTimeline"></div>
    </div>
  </div>

  <!-- Bottom row -->
  <div class="grid grid-cols-1 gap-4 lg:grid-cols-2">
    <div class="dash-card rounded-2xl border border-gray-200 bg-white p-4 shadow-sm">
      <div class="mb-2 flex items-center justify-between">
        <h2 class="text-sm font-semibold text-gray-900">{% trans "Просрочки по департаментам" %}</h2>
      </div>
      <div class="h-80" id="chartSlaOverdueDepartments"></div>
      <div class="mt-2 hidden text-sm text-red-600" data-chart-error="chartSlaOverdueDepartments"></div>
    </div>

    <div class="dash-card rounded-2xl border border-gray-200 bg-white p-4 shadow-sm">
      <div class="mb-2 flex items-center justify-between">
        <h2 class="text-sm font-semibold text-gray-900">{% trans "Компании по категориям" %}</h2>
      </div>
      <div class="h-80" id="chartCompaniesCategories"></div>
      <div class="mt-2 hidden text-sm text-red-600" data-chart-error="chartCompaniesCategories"></div>
    </div>
  </div>

  <div class="grid grid-cols-1 gap-4 lg:grid-cols-2">
    <div class="dash-card rounded-2xl border border-gray-200 bg-white p-4 shadow-sm">
      <div class="mb-2 flex items-center justify-between">
        <h2 class="text-sm font-semibold text-gray-900">{% trans "Компании по регионам" %}</h2>
      </div>
      <div class="h-80" id="chartCompaniesRegions"></div>
      <div class="mt-2 hidden text-sm text-red-600" data-chart-error="chartCompaniesRegions"></div>
    </div>

    <div class="dash-card rounded-2xl border border-gray-200 bg-white p-4 shadow-sm">
      <div class="mb-2 flex items-center justify-between">
        <h2 class="text-sm font-semibold text-gray-900">{% trans "Качество данных компаний" %}</h2>
      </div>
      <div class="h-80" id="chartDataQuality"></div>
      <div class="mt-2 hidden text-sm text-red-600" data-chart-error="chartDataQuality"></div>
    </div>
  </div>


</div>

{# ECharts подключаем один раз, безопасно для шаблонов панели #}
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
{% endblock %}
